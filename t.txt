kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
# Wait for cert manager
kubectl apply -f cockroach/cockroach_issuer.yaml
helm repo add cockroachdb https://charts.cockroachdb.com/
helm repo update
helm install cockroach --values cockroach/cockroach_values.yaml cockroachdb/cockroachdb
kubectl label svc cockroach-cockroachdb prometheus=cockroachdb
#Get latest version here https://github.com/prometheus-operator/prometheus-operator/releases/
kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.73.0/bundle.yaml --server-side
kubectl apply -f cockroach/prometheus.yaml
# Configure this
kubectl create secret generic alertmanager-cockroachdb --from-file=alertmanager.yaml=cockroach/alertmanager-config.yaml
kubectl label secret alertmanager-cockroachdb app=cockroachdb
kubectl apply -f cockroach/alertmanager.yaml
kubectl apply -f https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/prometheus/alert-rules.yaml
# There is a dummy rule there
# Execute
# kubectl edit prometheusrules prometheus-cockroachdb-rules
# And delete
#- name: rules/dummy.rules
#  rules:
#  - alert: TestAlertManager
#    expr: vector(1)
kubectl apply -f cockroach/cockroach-secure.yaml



kubectl exec -it cockroachdb-client-secure -- cockroach sql --certs-dir=./cockroach-certs --host=cockroach-cockroachdb-public # Root

# SQL

CREATE USER roach WITH LOGIN PASSWORD 'password';
CREATE TABLE IF NOT EXISTS links(short_link TEXT, full_link TEXT, PRIMARY KEY(short_link, full_link));
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE links TO roach;

# No SQL

helm install redis oci://registry-1.docker.io/bitnamicharts/redis

kubectl apply -f app.yaml

# Access to cluster useful information

kubectl port-forward service/cockroach-cockroachdb-public 8080 # localhost:8080 / roach:password
kubectl port-forward prometheus-cockroachdb-0 9090 # localhost:9090
kubectl port-forward alertmanager-cockroachdb-0 9093 # localhost:9093

minikube delete ; minikube start --cpus=8 --memory=15800

